# Simple development Dockerfile for Idun Agent Manager
FROM python:3.12-slim

# Environment variables
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONPATH=/app/src

# Install system dependencies and uv
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    libpq-dev \
    curl \
    && rm -rf /var/lib/apt/lists/* \
    && pip install --no-cache-dir uv

WORKDIR /app

# Copy only pyproject.toml for dependency resolution
COPY pyproject.toml ./

# Expose port
EXPOSE 8000

# Install dependencies at runtime:
# 1. Sync manager dependencies (creates venv at /app/.venv)
# 2. Uninstall PyPI schema from venv
# 3. Install local schema into the venv (editable)
# 4. Run uvicorn from the venv with reload
CMD ["bash", "-c", "\
    echo '=== Syncing manager dependencies ===' && \
    uv sync --project /app && \
    echo '=== Removing PyPI schema from venv ===' && \
    uv pip uninstall --python /app/.venv/bin/python idun-agent-schema && \
    echo '=== Installing local schema into venv ===' && \
    uv pip install --python /app/.venv/bin/python --no-deps -e /schema && \
    echo '=== Verifying schema location ===' && \
    /app/.venv/bin/python -c 'import idun_agent_schema; print(f\"Schema: {idun_agent_schema.__file__} v{idun_agent_schema.__version__}\")' && \
    echo '=== Starting uvicorn ===' && \
    /app/.venv/bin/python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload \
"]
